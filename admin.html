<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
  body {background:#121212;color:white;font-family:Arial;}
  h2 {text-align:center;margin-top:20px;}
  table {margin:20px auto;border-collapse:collapse;width:95%;}
  th,td {border:1px solid #555;padding:6px;text-align:center;vertical-align:middle;}
  th{background:#333;}
  input{width:90%;background:#1c1c1c;color:white;border:none;padding:4px;}
  button{margin:3px;padding:6px 10px;border:none;border-radius:4px;background:#6A5ACD;color:white;cursor:pointer;}
  .small{padding:3px 6px;font-size:12px;}
  .del{background:#b33;}
  .resetSub{background:#c44;}
  .add{background:#3a7;}
  .save{background:#27ae60;}
</style>
</head>
<body>
  <h2>‚öô –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

  <table id="table">
    <thead>
      <tr>
        <th>Login</th>
        <th>Password</th>
        <th>Username</th>
        <th>Mem</th>
        <th>Sub (–ø–æ–¥–ø–∏—Å–∫–∞)</th>
        <th>can_download</th>
        <th>ID</th>
        <th>–£–¥–∞–ª–∏—Ç—å</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="text-align:center; margin-top:15px;">
    <input id="newLogin" placeholder="Login">
    <input id="newPass" placeholder="Password">
    <input id="newUser" placeholder="Username">
    <button class="add" onclick="addUser()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    <button class="save" onclick="saveToGitHub()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ GitHub</button>
    <button onclick="goOut()">‚¨Ö –í—ã–π—Ç–∏</button>
  </div>

<script>
// –î–µ–º–æ-–º–∞—Å—Å–∏–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let users=[
  {login:"admin",password:"1234",username:"Administrator",mem:"16384Mb",sub:"2090-01-01",ident:"1",can_download:true},
  {login:"user",password:"pass",username:"TestUser",mem:"4096Mb",sub:"-",ident:"2",can_download:false}
];

function renderUsers(){
  const tbody=document.querySelector("#table tbody");
  tbody.innerHTML="";
  users.forEach((u,i)=>{
    tbody.innerHTML+=`
      <tr>
        <td><input value="${u.login}" onchange="edit(${i},'login',this.value)"></td>
        <td><input value="${u.password}" onchange="edit(${i},'password',this.value)"></td>
        <td><input value="${u.username}" onchange="edit(${i},'username',this.value)"></td>
        <td><input value="${u.mem}" onchange="edit(${i},'mem',this.value)"></td>
        <td>
          <span id="sub_${i}">${u.sub}</span><br>
          <button class="small" onclick="giveSub(${i},1,'d')">+1–¥</button>
          <button class="small" onclick="giveSub(${i},1,'y')">+1–≥</button>
          <button class="small" onclick="giveSub(${i},10,'y')">+10–ª</button>
          <button class="small" onclick="giveSub(${i},900,'y')">+900–ª</button>
          <button class="small resetSub" onclick="resetSub(${i})">‚ùå –°–Ω—è—Ç—å</button>
        </td>
        <td><input type="checkbox" ${u.can_download?"checked":""} onchange="toggleDownload(${i},this.checked)"></td>
        <td>${u.ident}</td>
        <td><button class="del" onclick="delUser(${i})">‚ùå</button></td>
      </tr>
    `;
  });
}

// ---- utils ----
function edit(i,k,v){users[i][k]=v;}
function giveSub(i,a,t){
  let base=new Date();
  if(users[i].sub && users[i].sub!="-"){let c=new Date(users[i].sub);if(c>base)base=c;}
  if(t=="d") base.setDate(base.getDate()+a);
  if(t=="y") base.setFullYear(base.getFullYear()+a);
  users[i].sub=base.toISOString().split("T")[0];
  renderUsers();
}
function resetSub(i){users[i].sub="-";renderUsers();}
function toggleDownload(i,v){users[i].can_download=v;}
function delUser(i){users.splice(i,1);renderUsers();}
function addUser(){
  let id=users.length+1;
  users.push({
    login:document.getElementById("newLogin").value||"u"+id,
    password:document.getElementById("newPass").value||"1234",
    username:document.getElementById("newUser").value||"User"+id,
    mem:"1024Mb",sub:"-",ident:String(id),can_download:false
  });
  renderUsers();
}
function goOut(){window.location="index.html";}

// ---- GitHub API —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚ö†Ô∏è ----
async function saveToGitHub(){
  const OWNER="–¢–í–û–ô_GITHUB_–ù–ò–ö";
  const REPO="HydrogenDLC.net";
  const PATH="users.html";
  const TOKEN="ghp_–¢–í–û–ô_–¢–û–ö–ï–ù";  // ‚ö†Ô∏è —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å—é–¥–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ

  // –§–æ—Ä–º–∏—Ä—É–µ–º users.html —Å JSON
  const content = `
<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Users Database</title></head><body>
<script type="application/json" id="users-data">
${JSON.stringify(users,null,2)}
</script>
</body></html>`;

  // –ë–µ—Ä—ë–º SHA —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
  const url=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
  const getResp=await fetch(url,{headers:{Authorization:`token ${TOKEN}`}});
  const info=await getResp.json();

  // –ö–æ–¥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (base64)
  const encoded=btoa(unescape(encodeURIComponent(content)));

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª —á–µ—Ä–µ–∑ PUT
  const resp=await fetch(url,{
    method:"PUT",
    headers:{
      Authorization:`token ${TOKEN}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      message:"update users.html via Admin Panel",
      content:encoded,
      sha:info.sha
    })
  });

  if(resp.ok){
    alert("‚úÖ users.html –æ–±–Ω–æ–≤–ª—ë–Ω –≤ GitHub!");
  } else {
    alert("‚ùå –û—à–∏–±–∫–∞: "+await resp.text());
  }
}

renderUsers();
</script>
</body>
</html>
