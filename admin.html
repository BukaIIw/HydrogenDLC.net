<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
  body {background:#121212;color:white;font-family:Arial;}
  h2 {text-align:center;margin-top:20px;}
  table {margin:20px auto;border-collapse:collapse;width:95%;}
  th,td {border:1px solid #555;padding:6px;text-align:center;vertical-align:middle;}
  th {background:#333;}
  input {width:90%;background:#1c1c1c;color:white;border:none;padding:4px;}
  button {margin:3px;padding:6px 10px;border:none;border-radius:4px;background:#6A5ACD;color:white;cursor:pointer;}
  button:hover {opacity:0.9;}
  .del {background:#b33;}
  .add {background:#3a7;}
  .small {padding:3px 6px;font-size:12px;}
  .resetSub {background:#c44;}
</style>
</head>
<body>
  <h2>⚙ Панель администратора</h2>

  <table id="table">
    <thead>
      <tr>
        <th>Login</th>
        <th>Password</th>
        <th>Username</th>
        <th>Mem</th>
        <th>Sub (подписка)</th>
        <th>can_download</th>
        <th>ID</th>
        <th>Удалить</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="text-align:center; margin-top:15px;">
    <input id="newLogin" placeholder="Login">
    <input id="newPass" placeholder="Password">
    <input id="newUser" placeholder="Username">
    <button class="add" onclick="addUser()">➕ Добавить</button>
    <button onclick="goOut()">⬅ Выйти</button>
  </div>

<script>
// --- загрузка пользователей из users.html ---
async function loadUsers(){
  const resp = await fetch("users.html");
  const text = await resp.text();
  const match = text.match(/<script[^>]*id="users-data"[^>]*>([\s\S]*?)<\/script>/);
  return JSON.parse(match[1]);
}

let users = JSON.parse(localStorage.getItem("users")) || [];

// --- отрисовать таблицу ---
function renderUsers(){
  const tbody=document.querySelector("#table tbody");
  tbody.innerHTML="";
  users.forEach((u,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input value="${u.login}" onchange="edit(${i},'login',this.value)"></td>
      <td><input value="${u.password}" onchange="edit(${i},'password',this.value)"></td>
      <td><input value="${u.username}" onchange="edit(${i},'username',this.value)"></td>
      <td><input value="${u.mem}" onchange="edit(${i},'mem',this.value)"></td>
      <td>
        <span id="sub_${i}">${u.sub}</span><br>
        <button class="small" onclick="giveSub(${i},1,'d')">+1 день</button>
        <button class="small" onclick="giveSub(${i},1,'y')">+1 год</button>
        <button class="small" onclick="giveSub(${i},10,'y')">+10 лет</button>
        <button class="small" onclick="giveSub(${i},900,'y')">+900 лет</button>
        <button class="small resetSub" onclick="resetSub(${i})">❌ Снять</button>
      </td>
      <td>
        <input type="checkbox" ${u.can_download?"checked":""} onchange="toggleDownload(${i},this.checked)">
      </td>
      <td>${u.ident}</td>
      <td><button class="del" onclick="delUser(${i})">❌</button></td>
    `;
    tbody.appendChild(tr);
  });
  localStorage.setItem("users", JSON.stringify(users));
}

// --- редактирование ---
function edit(i,key,value){
  users[i][key]=value;
  localStorage.setItem("users", JSON.stringify(users));
}

// --- выдача подписки ---
function giveSub(i,amount,type){
  let baseDate = new Date();
  if(users[i].sub && users[i].sub !== "-"){
    let current = new Date(users[i].sub);
    if(current > baseDate) baseDate = current;
  }
  if(type==="d"){ baseDate.setDate(baseDate.getDate()+amount); }
  if(type==="y"){ baseDate.setFullYear(baseDate.getFullYear()+amount); }
  let newDate = baseDate.toISOString().split("T")[0];
  users[i].sub = newDate;
  document.getElementById("sub_"+i).innerText = newDate;
  localStorage.setItem("users",JSON.stringify(users));
}

// --- снять подписку ---
function resetSub(i){
  users[i].sub = "-";
  document.getElementById("sub_"+i).innerText="-";
  localStorage.setItem("users",JSON.stringify(users));
}

// --- toggle загрузку ---
function toggleDownload(i,val){
  users[i].can_download=val;
  localStorage.setItem("users", JSON.stringify(users));
}

// --- удалить пользователя ---
function delUser(i){
  users.splice(i,1);
  localStorage.setItem("users", JSON.stringify(users));
  renderUsers();
}

// --- добавить пользователя ---
function addUser(){
  let id=users.length+1;
  users.push({
    login:document.getElementById("newLogin").value||"user"+id,
    password:document.getElementById("newPass").value||"1234",
    username:document.getElementById("newUser").value||"User"+id,
    mem:"1024Mb",
    sub:"-",
    ident:String(id),
    can_download:false
  });
  localStorage.setItem("users", JSON.stringify(users));
  renderUsers();
}

// --- выход ---
function goOut(){ window.location="index.html"; }

// --- загрузка при старте ---
(async ()=>{
   if(users.length===0){
     users = await loadUsers(); // если localStorage пустой
     localStorage.setItem("users", JSON.stringify(users));
   }
   renderUsers();
})();
</script>
</body>
</html>
