<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
  body {background:#121212;color:#fff;font-family:Arial;}
  h2 {text-align:center;margin:20px;}
  table {margin:20px auto;border-collapse:collapse;width:95%;}
  th,td {border:1px solid #555;padding:6px;text-align:center;vertical-align:middle;}
  th {background:#333;}
  input {width:90%;background:#1c1c1c;color:#fff;border:none;padding:4px;}
  button {margin:3px;padding:6px 10px;border:none;border-radius:4px;background:#6A5ACD;color:#fff;cursor:pointer;}
  button:hover {opacity:0.9;}
  .del {background:#b33;}
  .add {background:#3a7;}
  .small {padding:3px 6px;font-size:12px;}
  .resetSub {background:#c44;}
  .save {background:#27ae60;}
</style>
</head>
<body>
  <h2>⚙ Панель администратора</h2>

  <table id="table">
    <thead>
      <tr>
        <th>Login</th>
        <th>Password</th>
        <th>Username</th>
        <th>Mem</th>
        <th>Sub (подписка)</th>
        <th>can_download</th>
        <th>ID</th>
        <th>Удалить</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="text-align:center; margin-top:15px;">
    <input id="newLogin" placeholder="Login">
    <input id="newPass" placeholder="Password">
    <input id="newUser" placeholder="Username">
    <button class="add" onclick="addUser()">➕ Добавить</button>
    <button class="save" onclick="downloadUsers()">💾 Скачать users.html</button>
    <a href="index.html"><button>⬅ Выйти</button></a>
  </div>

<script>
let users=[];

// ───────── Загрузка из users.html ─────────
async function loadUsers(){
  const resp = await fetch("users.html");
  const text = await resp.text();
  const match = text.match(/<script[^>]*id="users-data"[^>]*>([\s\S]*?)<\/script>/);
  if(match){
    users = JSON.parse(match[1]);
    render();
  }
}

// ───────── Отрисовка таблицы ─────────
function render(){
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML="";
  users.forEach((u,i)=>{
    tbody.innerHTML+=`
      <tr>
        <td><input value="${u.login}" onchange="edit(${i},'login',this.value)"></td>
        <td><input value="${u.password}" onchange="edit(${i},'password',this.value)"></td>
        <td><input value="${u.username}" onchange="edit(${i},'username',this.value)"></td>
        <td><input value="${u.mem}" onchange="edit(${i},'mem',this.value)"></td>
        <td>
          <span id="sub_${i}">${u.sub}</span><br>
          <button class="small" onclick="giveSub(${i},1,'d')">+1д</button>
          <button class="small" onclick="giveSub(${i},1,'y')">+1г</button>
          <button class="small" onclick="giveSub(${i},10,'y')">+10л</button>
          <button class="small" onclick="giveSub(${i},900,'y')">+900л</button>
          <button class="small resetSub" onclick="resetSub(${i})">❌ Снять</button>
        </td>
        <td><input type="checkbox" ${u.can_download?"checked":""} onchange="toggleDownload(${i},this.checked)"></td>
        <td>${u.ident}</td>
        <td><button class="del" onclick="delUser(${i})">❌</button></td>
      </tr>
    `;
  });
}

// ───────── Логика изменения ─────────
function edit(i,key,value){ users[i][key]=value; render(); }

function giveSub(i,amount,type){
  let base=new Date();
  if(users[i].sub && users[i].sub!="-"){
    let c=new Date(users[i].sub);
    if(c>base) base=c;
  }
  if(type=="d") base.setDate(base.getDate()+amount);
  if(type=="y") base.setFullYear(base.getFullYear()+amount);
  users[i].sub=base.toISOString().split("T")[0];
  render();
}
function resetSub(i){ users[i].sub="-"; render(); }
function toggleDownload(i,val){ users[i].can_download=val; }
function delUser(i){ users.splice(i,1); render(); }
function addUser(){
  let id=users.length+1;
  users.push({
    login:document.getElementById("newLogin").value||"user"+id,
    password:document.getElementById("newPass").value||"1234",
    username:document.getElementById("newUser").value||"User"+id,
    mem:"1024Mb",
    sub:"-",
    ident:String(id),
    can_download:false
  });
  render();
}

// ───────── Генерация нового users.html ─────────
function downloadUsers(){
  const content = `<!DOCTYPE html>
<html lang="ru">
<head><meta charset="UTF-8"><title>Users Database</title></head>
<body>
<script type="application/json" id="users-data">
${JSON.stringify(users,null,2)}
</script>
</body>
</html>`;
  const blob = new Blob([content],{type:"text/html"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "users.html";
  a.click();
}

loadUsers();
</script>
</body>
</html>
